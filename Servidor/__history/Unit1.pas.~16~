unit Unit1;

interface

uses Classes, DSServer, DSReflect, DSCommonServer, DSNames, DataBkr, uServerMethodsRest, uServerContainerRest, DSProviderDataModuleAdapter;
type

  TSimpleServerClass = class(TDSServerClass)
  private
    FPersistentClass: TPersistentClass;
    FExposeProvider : Boolean;

  protected
    function GetDSClass: TDSClass; override;
  public
    constructor Create(AOwner: TComponent; AServer: TDSCustomServer;
         AClass: TPersistentClass; ExposeProvider: Boolean; ALifeCycle: String);
         reintroduce; overload;
    procedure OnGetClass(DSServerClass: TDSServerClass;
          var PersistentClass: TPersistentClass; Comp:TComponent);
  end;

procedure RegisterServerClasses(AOwner: TComponent; AServer: TDSServer);
implementation

uses uPessoas;

constructor TSimpleServerClass.Create(AOwner: TComponent; AServer: TDSCustomServer; AClass: TPersistentClass; ExposeProvider: Boolean;
  ALifeCycle: String);
var
 i: Integer;
begin
{  inherited Create(nil);
  FPersistentClass := AClass;
  Self.Server := AServer;

  Self.OnGetClass( TDSServerClass(TDSServerClass), AClass );
  Self.LifeCycle := ALifeCycle;
}
  inherited Create(nil);
  FPersistentClass := AClass;
  FExposeProvider  := ExposeProvider;
  Self.Server := AServer;


//  Self.OnGetClass(TDSServerClass(AServer),AClass, AOwner);
  Self.LifeCycle := ALifeCycle;

end;

procedure TSimpleServerClass.OnGetClass(DSServerClass: TDSServerClass;
  var PersistentClass: TPersistentClass; Comp: TComponent);
begin
//  PersistentClass := uPessoas.TPessoas;
//  PersistentClass := uServerMethodsRest.TServerRest;
end;

function TSimpleServerClass.GetDSClass: TDSClass;
var
  isAdapted : Boolean;
begin
//  Result := TDSClass.Create(FPersistentClass, False);
//  Result := TDSClass.Create(FPersistentClass, False);
//  Result := TDSClass.Create(TDSProviderDataModuleAdapter, Result);
  isAdapted := FPersistentClass.InheritsFrom(TProviderDataModule);
  Result := TDSClass.Create(FPersistentClass, isAdapted);
  if FExposeProvider and (isAdapted) then
     Result := TDSClass.Create(TDSProviderDataModuleAdapter, Result);
end;
procedure RegisterServerClasses(AOwner: TComponent; AServer: TDSServer);
begin
  Assert(AServer.Started = False, 'Não é possível adicionar classes com o servidor ativo');
  TSimpleServerClass.Create(AOwner, AServer, TPessoas, True, TDSLifeCycle.Server);
  TSimpleServerClass.Create(AOwner, AServer, TServerRest, False, TDSLifeCycle.Session);
//  TSimpleServerClass.Create(AOwner, AServer, TCustomer, True, TDSLifeCycle.Session);
end;
end.
